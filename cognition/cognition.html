<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cognition Battery</title>

  <!-- style.css is at the root, this page is in /course/ -->
  <link rel="stylesheet" href="../style.css" />

  <style>
    :root { --maxw: 1100px; }

    html, body { height: 100%; }
    body { margin: 0; }

    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 14px 14px 40px; box-sizing: border-box; }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background: rgba(248,249,250,0.85); backdrop-filter: blur(10px);
      border: 1px solid var(--border, #e9ecef);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    .brand{ font-weight:650; letter-spacing:.2px; }
    .muted{ opacity:.78; }
    .small{ font-size:12.5px; line-height: 1.35; }

    .pill-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 11px; border-radius: 16px;
      border: 1px solid var(--border, #e9ecef);
      background: rgba(255,255,255,0.9);
      font-size: 13px; color: inherit; cursor: pointer; text-decoration:none;
      transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      white-space: nowrap;
    }
    .pill:hover{ transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
    .pill.primary{ background: var(--accent, #5bc2e7); color:#fff; border-color: rgba(0,0,0,0.05); }
    .pill.primary:hover{ background:#67c9ea; }
    .pill.danger{ background:#fff; border-color: rgba(220,53,69,0.25); }
    .pill.danger:hover{ background: rgba(220,53,69,0.06); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .card{
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border, #e9ecef);
      border-radius: 8px;
      box-shadow: 0 2px 14px rgba(0,0,0,0.05);
      padding: 12px;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* Intro screen (slides up) */
    .introOverlay{
      position: fixed;
      inset: 0;
      background: rgba(248,249,250,0.92);
      backdrop-filter: blur(10px);
      z-index: 50;

      display:flex;
      align-items: center;
      justify-content: center;

      transform: translateY(0);
      transition: transform 520ms ease, opacity 520ms ease;
      opacity: 1;
      padding: 18px;
      box-sizing: border-box;
    }
    .introOverlay.hide{
      transform: translateY(-110%);
      opacity: 0;
      pointer-events: none;
    }
    .introCard{
      width: 100%;
      max-width: 920px;
      background: rgba(255,255,255,0.96);
      border: 1px solid var(--border, #e9ecef);
      border-radius: 10px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.10);
      padding: 16px 16px 14px;
    }
    .introTitle{ font-weight: 750; font-size: 18px; margin: 0 0 6px; }
    .introLead{ margin: 0 0 10px; opacity: .82; line-height: 1.45; }

    .introCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 860px){
      .introCols{ grid-template-columns: 1fr; }
    }

    .introList{
      margin: 0;
      padding-left: 18px;
      line-height: 1.45;
      font-size: 13px;
      opacity: .9;
    }
    .introList li { margin: 6px 0; }

    .introTip{
      border: 1px solid var(--border, #e9ecef);
      border-radius: 10px;
      background: rgba(248,249,250,0.85);
      padding: 10px 10px;
      font-size: 13px;
      line-height: 1.45;
      opacity: .92;
    }

    .introActions{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid var(--border, #e9ecef);
    }

    /* Test header + container */
    .testHead{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
    }
    .testTitle{ font-weight: 700; margin: 0; }
    .testMeta{ font-size: 12.5px; opacity: .78; }

    .notice{
      border: 1px solid var(--border, #e9ecef);
      border-radius: 10px;
      background: rgba(248,249,250,0.85);
      padding: 10px 10px;
      font-size: 13px;
      line-height: 1.45;
      opacity: .92;
      margin-top: 10px;
    }

    .testShell{
      margin-top: 10px;
      border: 1px solid var(--border, #e9ecef);
      border-radius: 10px;
      background: rgba(255,255,255,0.98);
      padding: 10px;
      overflow: hidden;
    }

    .sep{ height: 10px; }

    /* Small result block inside each test frame */
    .resultBox{
      margin-top: 10px;
      border: 1px solid var(--border, #e9ecef);
      border-radius: 10px;
      background: rgba(248,249,250,0.80);
      padding: 10px;
      font-size: 13px;
      line-height: 1.45;
    }
    .resultBox code{
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Footer controls */
    .footerRow{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
  </style>
</head>

<body>
  <!-- Intro overlay (slides up on start) -->
  <div class="introOverlay" id="introOverlay" aria-modal="true" role="dialog">
    <div class="introCard">
      <div class="introTitle">Cognition Battery (Prototype)</div>
      <p class="introLead">
        This battery contains six short tasks. It is designed for repeated tracking during fasting.
        Please do the tests in one sitting, in the proposed order.
      </p>

      <div class="introCols">
        <div>
          <div class="muted small" style="margin-bottom:6px;">What you will do</div>
          <ul class="introList">
            <li><strong>PVT</strong> — sustained attention and reaction-time stability.</li>
            <li><strong>Go/No-Go</strong> — inhibitory control (impulsive errors).</li>
            <li><strong>DSST</strong> — processing speed and efficiency.</li>
            <li><strong>TMT-B</strong> — mental flexibility and set shifting.</li>
            <li><strong>Working memory</strong> — short attention span and memory span.</li>
            <li><strong>Dot comparison</strong> — perceptual accuracy (numerosity).</li>
          </ul>
        </div>

        <div class="introTip">
          <strong>Practical tips</strong><br/>
          • Use the same device and screen size each time.<br/>
          • Try to keep similar conditions (time of day, caffeine, sleep).<br/>
          • Do not overthink. Most tasks are designed to be fast and intuitive.<br/>
          • Your results are saved only in your browser (localStorage).<br/>
        </div>
      </div>

      <div class="introActions">
        <button class="pill danger" id="introClear" type="button" title="Clear saved results in this browser">
          Clear saved results
        </button>

        <div class="muted small">When you are ready, start the battery.</div>

        <button class="pill primary" id="introStart" type="button">
          Start battery
        </button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brand">Cognition</div>
        <div class="muted small" id="subline">
          Six short tests. Results are stored locally and can be exported at the end.
        </div>
      </div>

      <div class="pill-row">
        <button id="btnExportAll" class="pill" type="button" title="Export all results as one JSON file">
          Export all results
        </button>
        <button id="btnResetAll" class="pill danger" type="button" title="Clears all battery results in this browser">
          Reset
        </button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="testHead">
          <h2 class="testTitle" id="currentTestTitle">Ready</h2>
          <div class="testMeta" id="currentTestMeta">Start the battery to begin.</div>
        </div>

        <div class="notice" id="notice">
          You will do the tests one after another. At the end of each test, a short result summary will appear here.
          Then you can continue to the next one.
        </div>

        <div class="testShell" id="testShell">
          <!-- Test module will render here -->
          <div class="muted small">Waiting…</div>
        </div>

        <div class="resultBox" id="resultBox" style="display:none;">
          <div style="font-weight:650; margin-bottom:6px;">Latest saved result</div>
          <code id="resultJson">—</code>
        </div>

        <div class="sep"></div>

        <div class="footerRow">
          <div class="muted small" id="stepHint">Tip: keep a calm rhythm. Speed comes naturally.</div>

          <div class="pill-row">
            <button id="btnPrev" class="pill" type="button">Previous</button>
            <button id="btnNext" class="pill primary" type="button">Next</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    /********************************************************************
     * cognition.html (lightweight battery runner)
     * - Intro overlay that slides up on Start
     * - Loads each test as a JS module:
     *     export function init(container, api) { ... }
     * - Stores clean results object in localStorage
     * - Displays only minimal guidance + last saved result
     * - Exports one combined JSON at the end
     ********************************************************************/

    const STORAGE_KEY = "cognitionBattery.results.v1";

    const TESTS = [
      { id: "pvt",   title: "PVT",             file: "./cog1_pvt.js",  note: "Sustained attention and reaction-time stability." },
      { id: "gng",   title: "Go/No-Go",        file: "./cog2_gng.js",  note: "Inhibitory control and impulsive errors." },
      { id: "dsst",  title: "DSST",            file: "./cog3_dsst.js", note: "Processing speed and cognitive efficiency." },
      { id: "tmtb",  title: "TMT-B",           file: "./cog4_tmt.js",  note: "Mental flexibility and task switching." },
      { id: "wm",    title: "Working memory",  file: "./cog5_wb.js",   note: "Short attention and memory span." },
      { id: "dots",  title: "Dot comparison",  file: "./cog6_dots.js", note: "Perceptual accuracy (numerosity), minimal executive load." }
    ];

    const el = {
      introOverlay: document.getElementById("introOverlay"),
      introStart: document.getElementById("introStart"),
      introClear: document.getElementById("introClear"),

      btnExportAll: document.getElementById("btnExportAll"),
      btnResetAll: document.getElementById("btnResetAll"),
      btnPrev: document.getElementById("btnPrev"),
      btnNext: document.getElementById("btnNext"),

      currentTestTitle: document.getElementById("currentTestTitle"),
      currentTestMeta: document.getElementById("currentTestMeta"),
      notice: document.getElementById("notice"),
      testShell: document.getElementById("testShell"),

      resultBox: document.getElementById("resultBox"),
      resultJson: document.getElementById("resultJson"),
      stepHint: document.getElementById("stepHint"),
      subline: document.getElementById("subline")
    };

    const state = {
      index: 0,
      loadedTestId: null
    };

    function nowISO() { return new Date().toISOString(); }

    function loadAll() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { version: 1, createdAt: nowISO(), updatedAt: nowISO(), results: {} };
        const data = JSON.parse(raw);
        if (!data || typeof data !== "object") throw new Error("bad data");
        if (!data.results) data.results = {};
        return data;
      } catch {
        return { version: 1, createdAt: nowISO(), updatedAt: nowISO(), results: {} };
      }
    }

    function saveAll(obj) {
      obj.updatedAt = nowISO();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }

    function clearAll() {
      localStorage.removeItem(STORAGE_KEY);
    }

    function setNavState() {
      el.btnPrev.disabled = (state.index <= 0);
      el.btnNext.disabled = (state.index >= TESTS.length - 1);
      // Export is always available, but will be empty at first.
    }

    function showResultInline(testId) {
      const all = loadAll();
      const r = all.results?.[testId] || null;
      if (!r) {
        el.resultBox.style.display = "none";
        el.resultJson.textContent = "—";
        return;
      }
      el.resultBox.style.display = "block";
      el.resultJson.textContent = JSON.stringify(r, null, 2);
    }

    function setHeader() {
      const t = TESTS[state.index];
      el.currentTestTitle.textContent = `${state.index + 1}/${TESTS.length} — ${t.title}`;
      el.currentTestMeta.textContent = t.note;

      // Gentle guidance line
      const all = loadAll();
      const done = Object.keys(all.results || {}).length;
      el.subline.textContent = `${done}/${TESTS.length} tests saved on this device. Export at the end if needed.`;

      // Context notice (keeps users oriented)
      el.notice.innerHTML =
        `You are about to do <strong>${t.title}</strong>. ${t.note}
         <br/>When the test is finished, a short result summary will be saved automatically.`;
    }

    async function loadTest(index) {
      const t = TESTS[index];
      state.loadedTestId = t.id;

      setHeader();
      setNavState();

      // Reset container
      el.testShell.innerHTML = `<div class="muted small">Loading ${t.title}…</div>`;
      el.stepHint.textContent = "If something feels unclear, refresh the page and start again.";

      try {
        const mod = await import(t.file + `?v=${encodeURIComponent(String(Date.now()).slice(-6))}`);
        if (!mod || typeof mod.init !== "function") {
          throw new Error(`Module ${t.file} has no exported init(container, api).`);
        }

        // Provide API to the test module
        const api = {
          saveResult: (testId, metrics = {}, extra = {}) => {
            const all = loadAll();
            all.results[testId] = {
              testId,
              title: TESTS.find(x => x.id === testId)?.title || testId,
              savedAt: nowISO(),
              metrics: metrics || {},
              extra: extra || {}
            };
            saveAll(all);
            showResultInline(testId);
            // Small reassurance
            el.stepHint.textContent = "Result saved locally. You can continue to the next test.";
            el.subline.textContent = `${Object.keys(all.results || {}).length}/${TESTS.length} tests saved on this device. Export at the end if needed.`;
          },
          next: () => {
            if (state.index < TESTS.length - 1) {
              state.index += 1;
              loadTest(state.index);
            } else {
              el.stepHint.textContent = "Battery complete. You can export your results now.";
            }
          },
          prev: () => {
            if (state.index > 0) {
              state.index -= 1;
              loadTest(state.index);
            }
          },
          getAllResults: () => loadAll(),
          clearAllResults: () => clearAll()
        };

        // Render test UI
        el.testShell.innerHTML = "";
        mod.init(el.testShell, api);

        // Show last saved result (if any) for this test
        showResultInline(t.id);

      } catch (err) {
        el.testShell.innerHTML = `
          <div class="muted small" style="line-height:1.45;">
            <strong>Could not load ${t.title}.</strong><br/>
            ${String(err).replaceAll("<","&lt;").replaceAll(">","&gt;")}
            <div style="margin-top:10px;">
              Check that <code>${t.file}</code> exists and exports <code>init(container, api)</code>.
            </div>
          </div>
        `;
        el.resultBox.style.display = "none";
      }
    }

    function exportAll() {
      const all = loadAll();
      const blob = new Blob([JSON.stringify(all, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cognition-battery-results.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function hideIntroAndStart() {
      // slide up
      el.introOverlay.classList.add("hide");
      // remove after transition to avoid focus issues
      setTimeout(() => { el.introOverlay.style.display = "none"; }, 560);

      // start first test
      state.index = 0;
      loadTest(state.index);
    }

    // Events
    el.introStart.addEventListener("click", hideIntroAndStart);

    el.introClear.addEventListener("click", () => {
      clearAll();
      el.subline.textContent = `0/${TESTS.length} tests saved on this device. Export at the end if needed.`;
    });

    el.btnPrev.addEventListener("click", () => {
      if (state.index > 0) {
        state.index -= 1;
        loadTest(state.index);
      }
    });

    el.btnNext.addEventListener("click", () => {
      if (state.index < TESTS.length - 1) {
        state.index += 1;
        loadTest(state.index);
      } else {
        el.stepHint.textContent = "Battery complete. You can export your results now.";
      }
    });

    el.btnExportAll.addEventListener("click", exportAll);

    el.btnResetAll.addEventListener("click", () => {
      clearAll();
      // Keep user oriented
      el.resultBox.style.display = "none";
      el.resultJson.textContent = "—";
      el.stepHint.textContent = "All saved results were cleared for this browser.";
      el.subline.textContent = `0/${TESTS.length} tests saved on this device. Export at the end if needed.`;
    });

    // Initial state (we keep intro visible)
    (function init() {
      setNavState();
      el.currentTestTitle.textContent = "Ready";
      el.currentTestMeta.textContent = "Start the battery to begin.";
      el.testShell.innerHTML = `<div class="muted small">Waiting…</div>`;
      el.resultBox.style.display = "none";

      const all = loadAll();
      const done = Object.keys(all.results || {}).length;
      el.subline.textContent = `${done}/${TESTS.length} tests saved on this device. Export at the end if needed.`;
    })();
  </script>
</body>
</html>

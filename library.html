<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buchinger Science – Research Library</title>
  <link rel="stylesheet" href="style.css">

  <!-- Small, page-local styling for the Explore UI.
       You can move these rules into style.css later if you prefer. -->
  <style>
    .library-wrap { max-width: 1100px; margin: 0 auto; padding: 34px 18px 56px; }
    .library-head { display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .library-head h2 { margin: 0; font-size: 20px; }
    .library-meta { font-size: 12px; opacity: .75; }

    .lib-panel {
      margin-top: 14px;
      border-radius: 18px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
    }

    .lib-controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .lib-search {
      flex: 1 1 280px;
      display:flex; align-items:center; gap:10px;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.04);
    }
    .lib-search label { font-size: 12px; opacity: .75; }
    .lib-search input {
      width: 100%;
      border: 0;
      outline: 0;
      background: transparent;
      color: inherit;
      font-size: 13px;
    }
    .lib-select, .lib-btn {
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.04);
      color: inherit;
      font-size: 13px;
    }
    .lib-btn { cursor: pointer; }
    .lib-btn:hover, .lib-select:hover { border-color: rgba(91,194,231,0.45); }

    .topic-pills { display:flex; gap:8px; flex-wrap:wrap; margin-top: 12px; }
    .pill {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.03);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      opacity: .85;
      cursor: pointer;
      user-select:none;
    }
    .pill:hover { border-color: rgba(91,194,231,0.45); opacity: 1; }
    .pill.on { border-color: rgba(91,194,231,0.60); background: rgba(91,194,231,0.10); opacity: 1; }

    .results-grid {
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    @media (max-width: 980px) { .results-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 620px) { .results-grid { grid-template-columns: 1fr; } }

    .study-card {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 18px;
      padding: 14px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .study-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.06); border-color: rgba(91,194,231,0.35); }

    .study-top { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .badge-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge {
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      opacity: .85;
      white-space: nowrap;
    }
    .badge.pub { border-color: rgba(119,242,183,0.35); background: rgba(119,242,183,0.08); }
    .badge.pre { border-color: rgba(255,210,138,0.35); background: rgba(255,210,138,0.08); }

    .btn-mini {
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.03);
      color: inherit;
      font-size: 11px;
      opacity: .90;
      cursor: pointer;
      text-decoration: none;
      line-height: 1;
    }
    .btn-mini:hover { border-color: rgba(91,194,231,0.45); opacity: 1; text-decoration:none; }
    .yt-dot { width: 8px; height: 8px; border-radius: 999px; background: rgba(255, 80, 80, 0.95); display:inline-block; }

    .study-title { margin: 10px 0 0; font-size: 14px; line-height: 1.25; }

    .chip-row { margin-top: 10px; display:flex; gap:6px; flex-wrap:wrap; }
    .chip {
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.03);
      opacity: .9;
    }

    details.findings { margin-top: 12px; }
    details.findings summary { cursor:pointer; font-size: 12px; opacity: .85; }
    details.findings ul { margin: 10px 0 0; padding-left: 18px; font-size: 12.5px; opacity: .85; line-height: 1.55; }
    details.findings li { margin: 7px 0; }

    .links-row { margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .study-link { font-size: 12.5px; text-decoration:none; }
    .study-link:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <nav>
    <div class="logo">Buchinger Science</div>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="metabolic.html">Metabolic Explorer</a></li>
      <li><a href="library.html">Research Library</a></li>
      <li><a href="videos.html">Amplius Videos</a></li>
      <li><a href="method.html">Our Method</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>

  <section class="hero" style="background-image: url('hero.png');">
    <div class="content">
      <h1>Research Library</h1>
      <p>
        Peer-reviewed publications, clinical studies and scientific reviews
        produced by the Buchinger Wilhelmi research teams.
      </p>
    </div>
  </section>

  <!-- Explore (search + topic filters + sort) -->
  <section class="library-wrap" id="research-library">
    <div class="library-head">
      <h2>Explore</h2>
      <div class="library-meta" id="resultCount">–</div>
    </div>

    <div class="lib-panel">
      <div class="lib-controls">
        <div class="lib-search" title="Search across titles, keywords and key findings">
          <label for="q">Search</label>
          <input id="q" type="text" placeholder="Example: microbiome, LDL, inflammation, stress, autophagy…" />
        </div>

        <select class="lib-select" id="sort" aria-label="Sort">
          <option value="new">Newest first</option>
          <option value="old">Oldest first</option>
          <option value="az">Title A → Z</option>
          <option value="bul">Most findings</option>
        </select>

        <button class="lib-btn" id="btnClear" type="button">Clear</button>
      </div>

      <div class="topic-pills" id="topicPills"></div>

      <div class="results-grid" id="grid"></div>
    </div>
  </section>

  <footer>
    <p>&copy; 2026 Buchinger Science. All rights reserved.</p>
  </footer>

  <script>
    // This page expects a JSON file named "library.json" next to library.html
    // Format: { topics: [{key,label}], studies: [{id,title,year,topics,bullets,link,youtube,published}] }

    const $ = (sel) => document.querySelector(sel);

    function esc(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function sortStudies(list, mode) {
      const a = [...list];
      if (mode === "new") a.sort((x,y) => (y.year||0) - (x.year||0));
      if (mode === "old") a.sort((x,y) => (x.year||0) - (y.year||0));
      if (mode === "az") a.sort((x,y) => (x.title||"").localeCompare(y.title||""));
      if (mode === "bul") a.sort((x,y) => (y.bullets?.length||0) - (x.bullets?.length||0));
      return a;
    }

    fetch("library.json")
      .then(r => r.json())
      .then(DB => {

        const selectedTopics = new Set();
        const pillsHost = $("#topicPills");

        function topicLabel(key) {
          const t = DB.topics.find(x => x.key === key);
          return t ? t.label : key;
        }

        DB.topics.forEach(t => {
          const el = document.createElement("div");
          el.className = "pill";
          el.textContent = t.label;
          el.addEventListener("click", () => {
            if (selectedTopics.has(t.key)) {
              selectedTopics.delete(t.key);
              el.classList.remove("on");
            } else {
              selectedTopics.add(t.key);
              el.classList.add("on");
            }
            render();
          });
          pillsHost.appendChild(el);
        });

        function matches(study, query) {
          if (!query) return true;
          const q = query.toLowerCase();
          const hay = (study.title + " " + (study.bullets||[]).join(" ") + " " + (study.topics||[]).join(" ")).toLowerCase();
          return hay.includes(q);
        }

        function topicOk(study) {
          if (selectedTopics.size === 0) return true;
          const set = new Set(study.topics || []);
          for (const t of selectedTopics) {
            if (!set.has(t)) return false;
          }
          return true;
        }

        function render() {
          const query = $("#q").value.trim();
          const mode = $("#sort").value;

          const filtered = DB.studies.filter(s => matches(s, query) && topicOk(s));
          const sorted = sortStudies(filtered, mode);

          $("#resultCount").textContent = `${sorted.length} / ${DB.studies.length} studies`;

          const grid = $("#grid");
          grid.innerHTML = "";

          sorted.forEach(s => {
            const card = document.createElement("div");
            card.className = "study-card";

            const badgeClass = s.published ? "badge pub" : "badge pre";
            const badgeText = s.published ? "Published / Link" : "Preprint / No link";

            const chips = (s.topics || []).slice(0, 6)
              .map(k => `<span class="chip">${esc(topicLabel(k))}</span>`)
              .join("");

            const more = (s.topics || []).length > 6
              ? `<span class="chip">+${(s.topics.length - 6)}</span>`
              : "";

            const bullets = (s.bullets || []).map(b => `<li>${esc(b)}</li>`).join("");

            const pubLink = s.link
              ? `<a class="study-link" href="${esc(s.link)}" target="_blank" rel="noopener">View study</a>`
              : "";

            const ytBtn = s.youtube
              ? `<a class="btn-mini" href="${esc(s.youtube)}" target="_blank" rel="noopener" title="Watch the short video for this study"><span class="yt-dot"></span>YouTube</a>`
              : "";

            card.innerHTML = `
              <div class="study-top">
                <div class="badge-row">
                  <span class="${badgeClass}">${badgeText}</span>
                  <span class="badge">${s.year || "—"}</span>
                </div>
                ${ytBtn}
              </div>

              <h3 class="study-title">${esc(s.title)}</h3>

              <div class="chip-row">${chips}${more}</div>

              <details class="findings">
                <summary>Show key findings</summary>
                <ul>${bullets}</ul>
                <div class="links-row">
                  ${pubLink}
                </div>
              </details>
            `;

            grid.appendChild(card);
          });
        }

        $("#q").addEventListener("input", render);
        $("#sort").addEventListener("change", render);
        $("#btnClear").addEventListener("click", () => {
          $("#q").value = "";
          selectedTopics.clear();
          document.querySelectorAll(".pill").forEach(p => p.classList.remove("on"));
          $("#sort").value = "new";
          render();
        });

        render();
      })
      .catch(error => {
        console.error("Error loading research library:", error);
      });
  </script>

</body>
</html>
